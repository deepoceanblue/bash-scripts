#!/bin/bash
##############################################
#
# name: _tmux
# author: Tomasz Winiarski
# date; 20200124
# desc: simplifies handling of tmux sessions
#       including use of presets and ability
#       to autocreate the default session.
# deps: tmux, _mmenu (for -m)
#
# USAGE: use _tmux --help or see helpMsg below
# 
##############################################
#
# TODO: add presets 
#
function helpMsg {
  cat << 'HELPMSG'

    _tmux -- simplifies handling of tmux session

    USAGE:

      _tmux <session-name> [<command>]

      _tmux [options]

      Invoked with no arguments it will create default session with auto-
      generated name, running bash.

      When invoked with no option, first arg is session-name, the optional 
      rest is the shell command to be executed.

      If session-name already exist, it will be attached to the terminal.
      If inside tmux session, will switch to session-name.

      If no session name is passed (directly or via -s) it will be autogenerated
      from current date and time (%Y%m%d%H%M%S).

      Valid cli options are:

      --command|-c
        :command to be executed in new window.
         Must be the last option.

      --help|-h
        :prints this message and exit.

      --preset|-p [<preset name>] : NOT FULLY IMPLEMENTED
        :spawns *new* session with custom names, layout and applications running.
         Valid preset names are:
           (layout only): master-slave|ms, horizontal-split|hs, vertical-split|vs
                          grid|g
           (layout and cmds): network-monitor|nm, system-monitor|sm, coding|c
         Must be the last option.
         All options except -s and -d will be silently discarded. 
         

      --run-detached|-d
        :spawn detached session.

      --choose-session-from-menu|-m
        :allows you to choose session to attach to from menu.
         If new name is provided (e.g. in dmenu), the session
         will be created/attached/switched to as usual.

      --session-name|-s [<session-name>]
        :sets the name of a session.

HELPMSG
}


function chooseSessionFromMenu {
  local sName
  tmuxVer=$(tmux -V)
  tmuxVer="${tmuxVer##* }"
  if [[ ${tmuxVer%%.*} -lt 2 ]]; then
  # for tmux ver. that do not support #{var} syntax
  # we compare only maior ver no
    local -a sNames
    while read sName ; do
      sNames+=("${sName%%:*}") # ':' is a separator in tmux output
    done < <(tmux list-sessions 2>/dev/null) # we discard stderr to not pollute sNames with err msg 
    printf '%s\n' "${sNames[@]}" | _mmenu
  else
  # for newer tmux
    tmux list-sessions -F \#{session-name} | _mmenu
  fi
  return 0
}

function use_preset { # TODO: make proper pure function?
  [[ -n $@ ]] || exit 130 # TODO: add presets
  preset="$@" # do not make them local for now

  case "$preset" in

    hs|horizontal-split)
      splits=1
      layout="3c80,192x46,0,0[192x23,0,0,17,192x22,0,24,19]"
    ;;

    vs|vertical-split) echo "$preset" 
      splits=1
      layout="06d7,192x46,0,0{96x46,0,0,17,95x46,97,0,18}"
    ;;

    ms|master-slave) echo "$preset"
      splits=1
    ;;

    grid|g) echo "$preset"
      splits=3

    ;;

    c|coding) echo "$preset";;
    nm|network-monitor) echo "$preset";;
    sm|system-monitor) echo "$preset";;
  esac
}

declare defaultCmd="/bin/bash"

declare cmd
declare sessionName
declare runDetached

while :; do

  case "$1" in 
    --session-name|-s) sessionName="$2" ; shift 2 ;;    
    --command|-c) shift; cmd="${@}" ; break ;;
    --help|-h) helpMsg ; exit 0 ;;
    --preset|-p) use_preset "$2" ; shift 2 ; break ;;
    --run-detached|-d) runDetached="-d" ; shift 1 ;; # option to a tmux new(-session) command
    --choose-session-from-menu|-m) sessionName="$(chooseSessionFromMenu)" ; shift 1 ;; 
    '') break;;
    *) sessionName="$1" ; shift 1 ; cmd="$@" ; break ;;
  esac

done

declare sessionExists
declare renameSession

if [[ -n "${sessionName}" ]]; then 
  tmux has-session -t "$sessionName" 2>/dev/null
  [[ $? == 0 ]] && sessionExists="true"
else
  sessionName="$(date +%Y%m%d%H%M%S)"
  renameSession="tmux command-prompt -I \"#S\" \"rename-session -- '%%'\";"
fi

if [[ "$sessionExists" == true ]]; then # code repeated to avoid issues
                                        # with multiple levels of quoting

    if [[ -z $TMUX ]]; then # if not inside tmux session

      if [[ -n $preset ]]; then
        tmux attach-session -d -t $sessionName \; select-layout $layout 
      elif [[ -n $cmd ]]; then
        tmux attach-session -d -t $sessionName \; new-window $cmd
      else
        tmux attach-session -d -t $sessionName
      fi

    else
      if [[ -n $preset ]]; then
        tmux-switch -t "$sessionName"\; select-layout $layout; 
      elif [[ -n $cmd ]]; then
        tmux switch -t "$sessionName" \; new-window $cmd\
      else
        tmux switch -t "$sessionName"
      fi
    fi

else 
    tmux new-session ${runDetached} -s ${sessionName} "${renameSession}${cmd:-${defaultCmd}}\;"
fi

#vim: ft=bash ts=2 tw=2
